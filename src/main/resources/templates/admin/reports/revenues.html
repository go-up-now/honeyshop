<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{/admin/layout/layout::layout(~{::title}, ~{::#main}, ~{::#jquery})}">

<head>
    <meta charset="UTF-8">
    <title>Doanh thu</title>
</head>

<body>
<div id="main">
    <!-- DataTales Example -->
    <div class="card shadow mb-4">
        <div class="card-header d-flex">
            <div class="col-md-12">
                <h3 class="m-0 font-weight-bold text-primary">Thống kê doanh thu</h3>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                    <thead>
                    <tr>
                        <th>STT</th>
                        <th>Khách hàng</th>
                        <th>Tên sản phẩm</th>
                        <th>Số lượng</th>
                        <th>Đơn giá</th>
                        <th>Doanh thu</th>
                        <th>Thời gian</th>
                    </tr>
                    </thead>
                    <tbody id="tableRevenue">
                    <!-- Dữ liệu sẽ được thêm vào đây bởi DataTables -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer">
            <div class="total-price" style="text-align: left;">
                <p><strong>Tổng doanh thu: <span id="totalPrice">0 đ</span></strong></p>
            </div>
        </div>
    </div>
</div>

<div id="jquery">
    <script>
        $(document).ready(function() {
            // Nếu DataTable đã được khởi tạo, hãy hủy khởi tạo trước khi tiếp tục
            if ($.fn.DataTable.isDataTable('#dataTable')) {
                $('#dataTable').DataTable().clear().destroy();
            }

            // Khởi tạo DataTable
            const table = $('#dataTable').DataTable({
                "ajax": {
                    "url": "/honeyshop/api/report", // URL của API để lấy dữ liệu
                    "type": "GET",
                    "dataSrc": function (json) {
                        let totalRevenue = 0;

                        const data = json.map((item, index) => {
                            totalRevenue += item.revenue;
                            return [
                                index + 1, // STT
                                item.userFullName,
                                item.productName,
                                item.quantity,
                                formatCurrency(item.price),
                                formatCurrency(item.revenue),
                                formatDate(item.day)
                            ];
                        });

                        // Cập nhật tổng doanh thu
                        $('#totalPrice').text(formatCurrency(totalRevenue));

                        return data;
                    }
                },
                "columns": [
                    { "title": "STT" },
                    { "title": "Khách hàng" },
                    { "title": "Tên sản phẩm" },
                    { "title": "Số lượng" },
                    { "title": "Đơn giá" },
                    { "title": "Doanh thu" },
                    { "title": "Thời gian" }
                ],
                processing: true,
                serverSide: false,
                paging: true,
                searching: true,
                ordering: true,
                info: true
            });

            // Hàm định dạng tiền tệ
            function formatCurrency(amount) {
                if (amount === null || amount === undefined) {
                    return '0 đ';
                }
                return amount.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
            }

            // Hàm định dạng ngày tháng
            function formatDate(dateString) {
                const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
                return new Date(dateString).toLocaleDateString('vi-VN', options);
            }
        });
    </script>
</div>
</body>
</html>
